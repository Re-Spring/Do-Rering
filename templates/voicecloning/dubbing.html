<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text-to-Speech with Voice Clone</title>
</head>
<body>
    <h1>User Voice Dubbing</h1>
    <!-- 사용자에게 이야기를 입력할 수 있는 텍스트 입력 폼 -->
    <form id="textForm">
        <!-- 회원 아이디 입력란 -->
        <input type="text" id="userId" required>
        <label for="userId">회원 아이디 입력</label><br>
        <label for="storyText">더빙하고 싶은 이야기를 입력해 주세요 :</label><br>
        <textarea id="storyText" name="storyText" rows="10" cols="50"></textarea><br>
        <!-- 텍스트를 음성으로 변환하는 버튼 -->
        <button type="submit">더빙하기</button>
    </form>
    
    <!-- 음성 파일을 재생하기 위한 오디오 태그 -->
    <audio controls id="audioPlayback" style="display: none;"></audio>

    <!-- 재생 버튼 -->
    <button id="playButton" style="display: none;">재생</button>

    <br><br>
    <a href="/cloneHome">첫페이지로</a>

    <script>
        // HTML 요소들 가져오기
        const textForm = document.getElementById('textForm');
        const audioPlayback = document.getElementById('audioPlayback');

        // 폼 제출 이벤트 핸들러 함수
        textForm.addEventListener('submit', function(event) {
            event.preventDefault(); // 폼 제출 기본 동작 막기
            const userId = document.getElementById('userId').value; // 회원 아이디 가져오기
            const storyText = document.getElementById('storyText').value; // 입력된 이야기 가져오기

            // 서버로 텍스트를 전송하여 음성 생성 요청 보내기
            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId: userId, storyText: storyText }) // 텍스트를 JSON 형식으로 변환하여 전송
            })
            .then(response => {
                if(!response.ok){
                    //서버로부터 오류 응답을 받은 경우
                    alert("아이디가 잘못되었습니다. 다시 시도해주세요")
                }
                return response.blob(); // 응답 데이터를 Blob 형식으로 파싱             
            })
            .then(blob => {
                // Blob 데이터를 URL로 변환하여 오디오 태그의 소스로 설정하여 재생
                const audioUrl = URL.createObjectURL(blob);
                audioPlayback.src = audioUrl;
                audioPlayback.style.display = 'block'; // 오디오 태그 표시
                playButton.style.display = 'block'; // 재생 버튼 표시
            })
            .catch(error => {
                console.error('Error:', error);
                alert("더빙 생성 중 오류가 발생했습니다. 불편을 드려 정말 죄송합니다. 다시 시도해 주세요.")}); // 오류 발생 시 콘솔에 로그 출력
        });

        // 재생 버튼 클릭 이벤트 핸들러 함수
        playButton.addEventListener('click', function() {
            audioPlayback.play(); // 오디오 재생
        });
    </script>
</body>
</html>
